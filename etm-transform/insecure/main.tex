\documentclass{article}
\usepackage[margin=1in,letterpaper]{geometry}
\usepackage{amsmath,amsfonts,amssymb,amsthm}

% For source code
\usepackage{listings}

% Algorithms and pseudocode
% \usepackage[linesnumbered,ruled,vlined]{algorithm2e}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{hyperref}

% Custom commands
\usepackage{crypto-primitives}
\usepackage{kyber-algos}

% Environments: definitions, theorems, propositions, corollaries, lemmas
%    Theorems, propositions, and definitions are numbered within the section
%    Corollaries are numbered within the theorem, though they are rarely used
\newtheorem{definition}{Definition}[section]
\newtheorem{theorem}{Theorem}[section]
\newtheorem*{remark}{Remark}
\newtheorem{corollary}{Corollary}[theorem]
\newtheorem{proposition}{Proposition}[section]
\newtheorem{lemma}{Lemma}[theorem]


\title{
    Document title
}
\author{
    Author 1
}
% Leave the date field empty to display the date of compilation
% \date{}

\begin{document}
%%%% TITLE %%%%%
% \maketitle

\begin{algorithm}[H]
    \caption{\texttt{Kyber.CCAKEM.KeyGen()}}\label{alg:ccakem-keygen}
    \begin{algorithmic}[1]
        \State $z \leftsample \mathcal{B}^{32}$
            \Comment{Randomly sample 32 bytes (256 bits)}
        \State $(\pk, \sk^\prime) \leftsample \texttt{Kyber.CPAPKE.KeyGen()}$
        \State $\sk = (\sk^\prime, \pk, H(\pk), z)$
            \Comment{H is instantiated with SHA3-256}
        \State \Return $(\pk, \sk)$
    \end{algorithmic}
\end{algorithm}

\begin{algorithm}[H]
    \caption{\texttt{Kyber.CCAKEM.Encap$^+$(\pk)}}\label{alg:ccakem-encap+}
    \begin{algorithmic}[1]
        \State $m \leftsample \mathcal{B}^{32}$
        \State $m = H(m)$
            \Comment{Do not output system RNG directly}
        \State $(\bar{K}, K_\mac, r) = G(m \Vert H(\pk))$
            \Comment{G is instantiated with SHA3-512}
        \State $c^\prime  \leftarrow \texttt{Kyber.CPAPKE.Enc(\pk, m, r)}$
            \Comment{Because $r$ is set, \texttt{CPAPKE} is deterministic}
            \State $t_1 = \mac(K_\mac, c^\prime)$
        \State $K = \texttt{KDF}(\bar{K} \Vert t_1)$
        \State $t_2=\mac(K, t_1)$
            \Comment{\texttt{KDF} is instantiated with Shake256}
        \State $c \leftarrow (c^\prime, t_1, t_2)$
        \State \Return $(c, K)$
    \end{algorithmic}
\end{algorithm}

\begin{algorithm}[H]
    \caption{$\texttt{Kyber.CCAKEM.Decap}^+ (\sk, c)$}\label{alg:ccakem-decap+}
    \begin{algorithmic}[1]
        \Require Secret key $\sk = (\sk^\prime, \pk, H(\pk), z)$
        \Require Ciphertext $c = (c^\prime, t_1, t_2)$
        \State $(\sk^\prime, \pk, h, z) \leftarrow \sk$
            \Comment{Unpack the secret key; $h$ is the hash of $\pk$}
        \State $(c^\prime, t_1, t_2) \leftarrow c$
        \State $m^\prime = \texttt{Kyber.CPAPKE.Dec}(\sk^\prime, c^\prime)$ 
        \State $(\overline{K},  K_\mac, r) =   G(m^\prime \Vert h)$
        \State $t_1^\prime=\mac(K_\mac, c^\prime)$
        \If{$t_1' = t_1$}
            \State $K  = \texttt{KDF}(\bar{K} \Vert t_1)$ 
            \State $t_2'= \mac(K, t_1)$
        \EndIf
        \If{$t_2'=t_2$}
            \State \Return $K$
        \Else
            \State Abort
        \EndIf
    \end{algorithmic}
\end{algorithm}

Unfortunately, the \texttt{Kyber+} construction is not \texttt{IND-CCA2} secure when combined with Kyber's \texttt{CPAPKE}. This is because there exists an efficient plaintext-checking attack against \texttt{CPAPKE} that can recover the secret key, and an \texttt{IND-CCA2} adversary against \texttt{KYBER+} can use the decapsulation oracle to simulate the plaintext-checking oracle, which means that an \texttt{IND-CCA2} adversary can run the plaintext-checking attack as a sub-routine and efficiently recover the secret key.

Let $B$ denote the plaintext-checking attack routine. It is given the public key $\pk$ (since the public key is identical between \texttt{CPAPKE} and \texttt{CCAKEM} there is no need to disambiguate) and access to the plaintext-checking oracle $\pco$ (see figure \ref{fig:pco}). After a number of plaintext checking queries, $B$ will output the $\sk^\prime$ that corresponds with the $\pk$ that it receives.

\begin{figure}[H]
    \centering
    \begin{minipage}{0.5\textwidth}
        \begin{algorithm}[H]
            \caption{$\pco(m, c^\prime)$}\label{alg:pco}
            \begin{algorithmic}
                \State \Return $\llbrack m = \texttt{Kyber.CPAPKE.Dec}(
                    \sk^\prime, c^\prime)\rrbrack$
            \end{algorithmic}
        \end{algorithm}
    \end{minipage}
    \caption{Plaintext checking oracle}\label{fig:pco}
\end{figure}

We now construct a chosen-ciphertext attack against \texttt{Kyber+}, which we will denote by $A$. $A$ will use $B$ as a sub-routine, which means that $A$ needs to \begin{enumerate}
    \item give $B$ a public key
    \item service $B$'s plaintext checking query
\end{enumerate}

Because \texttt{Kyber+}'s public key is identical to \texttt{Kyber.CPAPKE}'s public key, requirement 1 is trivial: $A$ just gives its own public key to $B$. To service $B$'s plaintext checking query $(\tilde{m}, \tilde{c}^\prime)$, $A$ will use the decapsulation oracle $\decap(c)$ (figure \ref{fig:decap-oracle}).

\begin{figure}[H]
    \centering
    \begin{minipage}{0.5\textwidth}
        \begin{algorithm}[H]
            \caption{$\decap(c)$}
            \begin{algorithmic}[1]
                \State \Return $\texttt{Kyber.CCAKEM.Decap}^+(\sk, c)$
            \end{algorithmic}
        \end{algorithm}
    \end{minipage}
    \caption{The decapsulation oracle}\label{fig:decap-oracle}
\end{figure}

$A$ can run through the steps of $\texttt{Kyber.CCAKEM.Encap}^+$ using ($\tilde{m}$, $\tilde{c}^\prime)$ and arrive at some (authenticated) ciphertext $c = (\tilde{c}^\prime, t_1, t_2)$ and session key $K$. $A$ then sends the $c$ to the decapsulation oracle, which might return some session key is $c$ is valid, or abort if $c$ is not valid. If $\tilde{m}$ is the decryption of $\tilde{c}^\prime$, then $A$'s output of $t_1, t_2$ will be correct, so the decapsulation oracle will accept. If $\tilde{m}$ is not the decryption of $\tilde{c}^\prime$, then $(\hat{K}, K_\mac, r) \leftarrow G(\tilde{m} \Vert H(\pk))$ does not produce the correct $\mac$ key, which means that $t_1, t_2$ will be incorrect, and the decapsulation oracle will abort. See figure \ref{fig:simulated-pco}

\begin{figure}[H]
    \centering
    \begin{algorithm}[H]
        \caption{$\pco_1(m, c^\prime)$}
        \begin{algorithmic}[1]
            \State $(\hat{K}, K_\mac, r) \leftarrow G(m \Vert H(\pk))$
                \Comment{Line 3 of algorithm \ref{alg:ccakem-encap+}}
            \State $t_1 \leftarrow \mac(K_\mac, c^\prime)$
                \Comment{Line 5}
            \State $K \leftarrow \texttt{KDF}(\hat{K} \Vert t_1)$
                \Comment{Line 6}
            \State $t_2 \leftarrow \mac(K, t_1)$
                \Comment{Line 7}
            \State $c \leftarrow (c^\prime, t_1, t_2)$
                \Comment{Line 8}
            \State \Return $\llbrack \decap(c) = K \rrbrack$
        \end{algorithmic}
    \end{algorithm}
    \caption{Simulated plaintext-checking oracle}\label{fig:simulated-pco}
\end{figure}

Here are the complete steps of the chosen-ciphertext attack \begin{enumerate}
    \item Challenger runs \texttt{CCAKEM.KeyGen} and gets $(\pk, \sk)$ where $\sk = (\sk^\prime, \pk, H(\pk), z)$
    \item Challenger gives $\pk$ to $A$, $A$ then gives $\pk$ to $B$
    \item For each of $B$'s plaintext checking query, $A$ runs $\pco_1$ and returns the result back to $B$
    \item After $B$ halts, it returns the recovered secret key $\sk^\prime$
    \item Challenger generates the challenge ciphertext $(c^\ast, K_0) \leftsample \texttt{Kyber.CCAKEM.Encap}^+(\pk)$, samples a random session key $K_1 \leftsample \{0,1\}^{256}$, flips a coin $b \leftsample \{0, 1\}$, then gives $(c^\ast, K_b)$ to $A$
    \item $A$ unpacks $c^\ast = (c^\prime, t_1, t_2)$, uses the recovered secret key $\sk^\prime$ to decrypt $c^\prime$. From here it is trivial to distinguish whether $K_b$ is the correct session key or the random session key
\end{enumerate}

\end{document}