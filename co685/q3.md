# Problem 3
Suppose that there exists a valid signature $(m, r, s)$ such that the bound-checked verification holds:

$$
r \equiv (g^\frac{H(m)}{s}h^\frac{r}{s} \mod p) \mod q
$$

Then both $\sigma_1 = (m, r + q, s)$ and $\sigma_2 = (m, r, s + q)$ can pass no-bound-checked verification. Thus we have forged signature for $m$ under the no-bound-checked verification.

The validity of the second forgery is straightforward: let $s^\prime = s + q$, then $s^{-1}$ is also a multiplicative inverse of $s^\prime$ under modulus $q$ since $s^\prime s^{-1} \equiv (s + q)s^{-1} \equiv ss^{-1} + qs^{-1} \equiv ss^{-1} \equiv 1 \mod q$. As a result, the RHS of the no-bound-check verification congruence remains unchanged despite replacing $s$ with $s^\prime = s + q$. The LHS of the no-bound-check remains trivially unchanged since $r$ is not changed. Therefore, the congruence still holds, and the no-bound-check verification will pass.

The validity of the first forgery is a bit more involved. First observe that the LHS of the congruence reduces back to $r$: $r + q \equiv r \mod q$. On the other hand, if we replace $r$ with $r^\prime = r + q$, then:

$$
\begin{aligned}
g^\frac{H(m)}{s}h^\frac{r^\prime}{s} &\equiv g^\frac{H(m)}{s}h^\frac{r + q}{s} \mod p \\
&\equiv g^\frac{H(m)}{s}h^\frac{r}{s}h^\frac{q}{s} \mod p \\
&\equiv g^\frac{H(m)}{s}h^\frac{r}{s}(g^\alpha)^\frac{q}{s} \mod p \\
&\equiv g^\frac{H(m)}{s}h^\frac{r}{s}(g^q)^\frac{\alpha}{s} \mod p
\end{aligned}
$$

Because $g \in \mathbb{Z}_p$ has order $q$, we know that $g^q \equiv 1 \mod p$, so the last term of the equation above is a power of $1$ under modulus $p$:

$$
g^\frac{H(m)}{s}h^\frac{r}{s}(g^q)^\frac{\alpha}{s} \equiv g^\frac{H(m)}{s}h^\frac{r}{s} \mod p
$$

Putting the arithmetics above together, we have the following congruences:

$$
\begin{aligned}
r &\equiv r^\prime \mod q \; \text{, (LHS is unchanged)}\\
g^\frac{H(m)}{s}h^\frac{r^\prime}{s} &\equiv g^\frac{H(m)}{s}h^\frac{r}{s} \mod p \; \text{, (RHS is unchanged)}\\
r &\equiv (g^\frac{H(m)}{s}h^\frac{r}{s} \mod p) \mod q \;\text{, (the original signature is valid)} \\
\end{aligned}
$$

From here we can easily conclude that 

$$
r^\prime \equiv (g^\frac{H(m)}{s}h^\frac{r^\prime}{s} \mod p )\mod q
$$

thus $(m, r+q, s)$ is also a valid forgery under the no-bound-check verification.

The the bound check will trivially deny both forgery since $r + q$ and $s+q$ are greater than or equal to $q$.


## Appendix: some sample code
```python
# Let's do a crude DSA forgery; values taken from
# An Introduction to Mathematical Cryptography, HPS
p, q, g = 48731, 443, 5260
m = 343  # Hash of the message, which is in Z_q
x = 242  # secret key
gx = pow(g, x, p)  # public key

k = 427
kinv = pow(k, -1, q)
r = pow(g, k, p) % q
s = (m + x * r) * kinv % q

def verify(r, s, m, g, pk, p, q, bounded: bool = True):
    if bounded:
        if r <= 0 or r >= q:
            return False
        if s <= 0 or s >= q:
            return False
    lhs = r % q
    
    s_inv = pow(s, -1, q)
    v1 = m * s_inv % q
    v2 = r * s_inv % q
    rhs = pow(g, v1, p) * pow(pk, v2, p) % p % q

    return lhs == rhs

assert verify(r, s, m, g, gx, p, q)
assert verify(r + q, s, m, g, gx, p, q, False)
assert verify(r, s + q, m, g, gx, p, q, False)
```